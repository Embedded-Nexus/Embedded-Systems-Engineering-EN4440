# Quick Start: Firmware OTA Update

## What Type of File is Expected?

**Answer: `.bin` (Binary file)**

- **File Extension**: `.bin`
- **Format**: Binary executable
- **MIME Type**: `application/octet-stream`
- **Size**: 200-500 KB (depending on code)
- **Generated By**: PlatformIO

### How to Generate:
```bash
pio run -e nodemcuv2
# Output: .pio/build/nodemcuv2/firmware.bin
```

---

## What Was Built

### New Files Created:
1. **`include/firmware_updater.h`** - Header file with public API
2. **`src/firmware_updater.cpp`** - Implementation of OTA update logic

### Files Modified:
1. **`src/main.cpp`** - Integrated firmware updater into main loop

---

## How It Works

### In the Main Cycle:

```
Every loop iteration:
â”œâ”€ PollingManager::handle()      [Poll inverter data - every 10s]
â”œâ”€ UploadManager::handle()       [Upload to cloud - every 30s]  
â”œâ”€ FirmwareUpdater::handle()     [Check firmware - every 5 minutes]
â”‚  â””â”€ If WiFi connected AND 5 min elapsed:
â”‚     â”œâ”€ GET /firmware (cloud server)
â”‚     â”œâ”€ Response: 200 (update available) or 204 (no update)
â”‚     â”œâ”€ If update available: Download & flash to device
â”‚     â””â”€ If successful: Device automatically restarts
â””â”€ Sleep/power management
```

### Update Check Flow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FirmwareUpdater::handle() called         â”‚
â”‚ (Every 5 minutes)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Is WiFi connected?  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†™ No       â†˜ Yes
             â†“            â†“
        [Skip]      [Check server]
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ GET /firmware        â”‚
              â”‚ http://192.168.137.1 â”‚
              â”‚   :5000/firmware     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Response
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ HTTP 200 with binary â”‚â”€â”€â”€â”€â†’ [Download & Flash]
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â†“
         â”‚ HTTP 204 No Content  â”‚â”€â”€â”€â”€â†’ [No update, continue]
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ HTTP 404 Not Found   â”‚â”€â”€â”€â”€â†’ [Error, continue]
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cloud Endpoint Reference

**Endpoint Definition** (from `cloud/app/routes/firmware.py`):

```python
@firmware_bp.route('/firmware', methods=['GET'])
def get_firmware_file():
    # Returns the latest firmware binary file
    info = get_firmware()  # Get from database
    response = send_file(info['file_path'], as_attachment=True)
    return response
```

### Endpoint Details:
- **URL**: `GET /firmware`
- **Host**: Cloud server (configured in main.cpp)
- **Response**: Binary file (`.bin`) or 204/404 status

---

## Configuration

### Firmware Endpoint URL
Location: `src/main.cpp` line ~86
```cpp
FirmwareUpdater::begin("http://192.168.137.1:5000/firmware", "1.0.0");
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                       Change this to your cloud server IP
```

### Current Version
Location: `src/main.cpp` line ~86
```cpp
FirmwareUpdater::begin("http://192.168.137.1:5000/firmware", "1.0.0");
                                                              ^^^^^^^
                       Update this as you release new versions
```

### Check Interval (5 minutes by default)
Location: `src/firmware_updater.cpp` line ~9
```cpp
static const unsigned long checkInterval = 300000; // milliseconds
// Change to: 30000 for 30 seconds (testing)
//           60000 for 1 minute
//          300000 for 5 minutes (default)
```

---

## Example: Upload and Deploy Firmware

### Step 1: Build New Firmware
```bash
pio run -e nodemcuv2
# Creates: .pio/build/nodemcuv2/firmware.bin
```

### Step 2: Upload to Cloud Server
```bash
curl -X POST \
  -F "file=@.pio/build/nodemcuv2/firmware.bin" \
  -F "level=1" \
  http://192.168.137.1:5000/firmware

# Response:
# {
#   "status": "success",
#   "message": "Firmware uploaded",
#   "version": "1.0.1",
#   "file_path": "/path/to/firmware.bin",
#   "update_level": 1
# }
```

### Step 3: Wait for Device Update
- Device automatically checks every 5 minutes
- Monitor serial console for update messages:
  ```
  [FirmwareUpdater] ğŸ” Checking for firmware updates...
  [FirmwareUpdater] âœ… Firmware update successful!
  [FirmwareUpdater] ğŸ”„ Rebooting device with new firmware...
  ```

### Step 4: Device Restarts
- Device boots with new firmware
- All systems re-initialize
- Normal operation resumes

---

## Expected Serial Output

### No Update Available:
```
[FirmwareUpdater] âœ… Initialized with endpoint: http://192.168.137.1:5000/firmware
[FirmwareUpdater] Current version: 1.0.0
[FirmwareUpdater] ğŸ” Checking for firmware updates at: http://192.168.137.1:5000/firmware
[FirmwareUpdater] â„¹ï¸ No new firmware available (current version is up-to-date)
```

### Update Available & Flashing:
```
[FirmwareUpdater] ğŸ” Checking for firmware updates...
[FirmwareUpdater] âœ… Firmware update successful!
[FirmwareUpdater] ğŸ”„ Rebooting device with new firmware...
[Device restarts...]
```

### Error During Update:
```
[FirmwareUpdater] âŒ Update failed! Error: (error message)
[FirmwareUpdater] Error code: -1
[Continues with old firmware]
```

---

## Key Points

âœ… **Binary Format**: `.bin` file from PlatformIO
âœ… **Automatic**: Checks every 5 minutes by default
âœ… **Non-blocking**: Doesn't interrupt normal operations
âœ… **WiFi Required**: Only checks when connected to WiFi
âœ… **Auto-Restart**: Device restarts after successful update
âœ… **Error Safe**: Continues with old firmware if update fails
âœ… **Cloud Ready**: Uses existing `/firmware` endpoint

---

## Files Overview

| File | Type | Purpose |
|------|------|---------|
| `include/firmware_updater.h` | Header | Public API |
| `src/firmware_updater.cpp` | Implementation | OTA logic |
| `src/main.cpp` | Modified | Integration |
| `cloud/app/routes/firmware.py` | Cloud | Firmware delivery |

---

## Testing Checklist

- [ ] Build firmware: `pio run -e nodemcuv2`
- [ ] Upload to cloud: `curl -X POST -F "file=@firmware.bin" ...`
- [ ] Monitor serial console
- [ ] Wait 5 minutes for check
- [ ] Verify device restarts with new firmware
- [ ] Confirm "No update" message on next check

---

## Documentation Files

For more details, see:
- `FIRMWARE_OTA_IMPLEMENTATION.md` - Full technical documentation
- `FIRMWARE_FILE_TYPE.md` - Detailed file format guide
- `FIRMWARE_OTA_CODE_SUMMARY.md` - Code changes and integration details
