# Compiled Firmware File Type Guide

## Expected File Type: `.bin` (Binary)

The firmware that gets deployed to the ESP8266 device must be in **binary format** with a `.bin` extension.

---

## File Specifications

| Property | Value |
|----------|-------|
| **File Extension** | `.bin` |
| **MIME Type** | `application/octet-stream` |
| **Format** | Binary (machine code) |
| **Size** | 200-500 KB typical |
| **Encoding** | No encoding (raw bytes) |

---

## How to Generate `.bin` File

### Using PlatformIO (Recommended)

```bash
# Navigate to project directory
cd <project-root>

# Build for NodeMCU ESP8266
pio run -e nodemcuv2

# Output location:
# .pio/build/nodemcuv2/firmware.bin
```

### Using Arduino IDE

1. Go to **Sketch → Export compiled Binary**
2. This generates `.bin` file in the sketch directory

---

## What's Inside the `.bin` File?

The binary file contains:
- **Application Code**: Your compiled C++ code
- **Data Sections**: Global variables and constants
- **Bootloader**: First-stage bootloader (usually separate)
- **Partition Table**: Memory layout information
- **Optional**: Filesystem data, SSL certificates

---

## File Characteristics

### Size
```
Typical ESP8266 firmware:
- Minimal code:     ~200 KB
- Medium project:   ~300 KB
- Large project:    ~500 KB
- Maximum:          ~1024 KB (1 MB for most boards)
```

### Checksum
- Binary includes internal checksum
- ESP8266 automatically verifies after flashing
- Corrupted downloads are rejected

### Compression
- Not compressed in final `.bin` file
- Ready to flash directly to device
- No decompression needed on device

---

## Uploading to Cloud Server

### File Upload Method

**POST /firmware endpoint** (from firmware.py)

```bash
curl -X POST \
  -F "file=@firmware.bin" \
  -F "level=1" \
  http://192.168.137.1:5000/firmware
```

### Supported File Names
- `firmware.bin` ✓
- `firmware_v1.0.1.bin` ✓
- `ecowatt-firmware.bin` ✓
- Any name ending in `.bin` ✓

### File Validation (Server-side)

The cloud server will:
1. Accept the `.bin` file
2. Save it to `cloud/firmware/` directory
3. Update database with version info
4. Serve it to devices via GET /firmware endpoint

---

## Device-Side Processing

When device requests firmware:

```
1. Device: GET /firmware
   ↓
2. Server: HTTP 200 + binary data
   ↓
3. Device: Receives binary in 1KB chunks
   ↓
4. Device: Writes each chunk to flash memory
   ↓
5. Device: Calculates checksum
   ↓
6. Device: Verifies checksum matches
   ↓
7. If OK: Restart with new firmware
   If FAIL: Keep old firmware, log error
```

---

## Verification

### Check if `.bin` File is Valid

```bash
# On Linux/Mac
file firmware.bin
# Output: firmware.bin: data

# Check file size
ls -lh firmware.bin
# Output: -rw-r--r--  1 user  group  245K firmware.bin
```

### Inspect Binary Header (Optional)

```bash
# Show first 16 bytes (hex)
hexdump -C firmware.bin | head -1
# Output: 00000000  e9 03 00 00 ... (ESP8266 magic bytes)
```

**ESP8266 Magic Bytes**: `e9 03 00 00`
- If your `.bin` starts with these bytes, it's valid for ESP8266

---

## Common Issues & Solutions

| Issue | Cause | Solution |
|-------|-------|----------|
| Upload fails | Wrong file format (not `.bin`) | Use PlatformIO to generate `.bin` |
| Device update fails | Corrupted binary | Regenerate `.bin` file |
| File size too large | Code too complex | Check partition size in platformio.ini |
| Checksum error | Incomplete download | Check network, retry update |
| Device doesn't restart | Update partially applied | Reset device manually |

---

## For Your Project

### Build Command
```bash
cd e:\UoM\Sem07\Embedded\Repo\Embedded-Systems-Engineering-EN4440
pio run -e nodemcuv2
```

### Output Location
```
.pio/build/nodemcuv2/firmware.bin
```

### Upload to Cloud
```bash
curl -X POST \
  -F "file=@.pio/build/nodemcuv2/firmware.bin" \
  -F "level=1" \
  http://192.168.137.1:5000/firmware
```

### Trigger Device Update
- Device checks automatically every 5 minutes
- Or wait for next scheduled check cycle
- Monitor via serial console for confirmation

---

## Summary

✅ **File Type**: `.bin` (binary executable)
✅ **Generated By**: PlatformIO build process
✅ **Size**: 200-500 KB typical
✅ **Format**: Raw machine code, ready to flash
✅ **Upload Method**: POST /firmware endpoint
✅ **Device Handles**: Automatic download and flashing
